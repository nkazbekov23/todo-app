<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
<?php
/**
 * Created by PhpStorm.
 * User: nargizaz
 * Date: 14.01.2017
 * Time: 11:46
 */
$asset = \app\assets\CalculatorAsset::register($this);
//Yii::app ()->getClientScript ()->registerScriptFile ( Yii::app()->theme->baseUrl. '/assets/js/jquery.PrintArea.js' );
?>
<div class="featured-box featured-box-secondary align-left mt-xlg">
    <div class="box-content">
        <h4 class="heading-secondary text-uppercase mb-md"><?=Yii::t('app', 'Loan Calculator')?></h4>
        <p><?=Yii::t('app', 'Здесь вы можете сделать предварительный расчет кредитования, за более точной информацией необходимо обратится к кредитному специалисту в одно из отделений DemirBank.')?></p>
        <form action="/" id="frmCalculateShipping" method="post">
            <div class="row">
                <div class="form-group">
                    <div class="col-md-6">
                        <label for="salary_project"><?=Yii::t('app', 'Currency')?></label>
                        <select id="currency_select" class="form-control mb-md">
                            <option value="kgs" selected>KGS</option>
                            <!-- <option value="usd">USD</option> -->
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="start_date"><?=Yii::t('app', 'Start date')?></label>
                        <input id="start_date" type="text"  class="form-control mb-md" placeholder="Start Date">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6  align-right">
                                <label for="loanAmountInput"><?=Yii::t('app', 'Loan Amount')?></label>
                            </div>
                            <div class="col-md-6">
                                <input id="loanAmountInput" type="text" class="form-control mb-md" placeholder="<?=Yii::t('app', 'Loan Amount')?>">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <input id="loanAmountSlider" type="range" placeholder="<?=Yii::t('app', 'Loan Amount')?>" class="mb-md">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6 align-right">
                                <label for="loanPeriodInput"><?=Yii::t('app', 'Loan Period')?></label>
                            </div>
                            <div class="col-md-6">
                                <input id="loanPeriodInput" type="text" class="form-control mb-md" placeholder="<?=Yii::t('app', 'Loan Period')?>">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <input id="loanPeriodSlider" type="range" placeholder="<?=Yii::t('app', 'Loan Period')?>">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <div class="col-md-6">
                        <div class="row">
                            <div class="col-md-6 align-right">
                                <label for="interestRateInput"><?=Yii::t('app', 'Interest Rate')?></label>
                            </div>
                            <div class="col-md-6">
                                <input id="interestRateInput" type="text" class="form-control mb-md" placeholder="<?=Yii::t('app', 'Interest Rate')?>">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <input id="interestRateSlider" type="range" placeholder="<?=Yii::t('app', 'Interest Rate')?>" class="mb-md">
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <button>result</button>
                </div>
            </div>
        </form>
    </div>
</div>

<hr>
<div id="result" class="print-area" title="Results" style="display: none">
    <h4 class="heading-secondary text-uppercase mb-md">Результат</h4>
    <a href="javascript:void(0)" class="print-btn text-red"><i class="fa fa-print"></i><span>Печать</span></a>
    <table class="table table-striped" style="max-height: 700px; overflow-y: scroll;">
        <thead>
        <tr>
            <th>#</th>
            <th style="width: 18%"><?=Yii::t('app','Installment')?></th>
            <th><?=Yii::t('app','Principal')?></th>
            <th><?=Yii::t('app', 'Interest')?></th>
            <th><?=Yii::t('app', 'Balance')?></th>
            <th><?=Yii::t('app', 'Date')?></th>
        </tr>
        </thead>
        <tbody id="result_table_id">

        </tbody>
    </table>
</div>


<hr>

<div class="featured-box featured-box-secondary align-left mt-xlg">
    <div class="box-content">
        <h4 class="heading-secondary text-uppercase mb-md">Заявка на  <span id="loanTextValue"></span></h4>
        <form id="loanForm" method="POST">
            <div id="clientIp" style="display: none;"><?php echo $_SERVER['REMOTE_ADDR']; ?></div>

            <div class="row">
                <div class="form-group">
                    <input id="consumerName" type="text" class="form-control mb-md" placeholder="ФИО"
                           data-required_mark="required"/>
                    <div class="text-danger text-xs errors" id="consumerNameError" hidden>Поле не может быть пустым</div>
                </div>
            </div>

            <div class="row">
                <div class="form-group row">
                    <div class="col-md-6  align-right">
                        <input id="emailAddress" type="email" class="form-control mb-md" placeholder="Email адрес"
                               data-required_mark="required"/>

                    </div>
                    <div class="col-md-6">
                        <input id="phoneNumber" type="text" class="form-control mb-md"
                               placeholder="+996 XXX XXX XXX" data-required_mark="required">
                        <div class="text-danger text-xs errors" id="phoneNumberError" hidden>Поле не может быть пустым</div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <select class="form-control mb-md" id="isDemirBankSalary">
                        <option value="">Получаете зарплату на карту DemirBank?</option>
                        <option value="true">Да</option>
                        <option value="false">Нет</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <select class="form-control mb-md" id="region">
                        <option value="">Выбрать регион</option>
                        <option value="Бишкек">Бишкек</option>
                        <option value="Ош">Ош</option>
                        <option value="Чуйская область">Чуйская область</option>
                        <option value="Иссыкульская область">Иссыкульская область</option>
                        <option value="Нарынская область">Нарынская область</option>
                        <option value="Таласская область">Таласская область</option>
                        <option value="Джалалабадская область">Джалалабадская область</option>
                        <option value="Ошская область">Ошская область</option>
                        <option value="Баткенская область">Баткенская область</option>
                    </select>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <input type="text" class="form-control mb-md" id="loanSum"
                           placeholder="Сумма кредита (полученная в кредитном калькуляторе)"/>
                    <div class="text-danger text-xs errors" id="loanSumError" hidden>Поле не может быть пустым</div>
                </div>
            </div>

            <div class="row">
                <div class="form-group">
                    <input type="text" class="form-control mb-md" id="monthPayment"
                           placeholder="Ежемесячный платеж (полученный в кредитном калькуляторе)"/>
                    <div class="text-danger text-xs errors" id="monthPaymentError" hidden>Поле не может быть пустым</div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <input type="text" class="form-control mb-md" id="initPayment"
                           placeholder="Первоначальный взнос"/>
                    <div class="text-danger text-xs errors" id="monthPaymentError" hidden>Поле не может быть пустым</div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <input type="text" class="form-control mb-md" id="carCost"
                           placeholder="Стоимость машины"/>
                    <div class="text-danger text-xs errors" id="monthPaymentError" hidden>Поле не может быть пустым</div>
                </div>
            </div>
            <div class="row">
                <div class="form-group">
                    <input type="text" class="form-control mb-md" id="mortgageCost"
                           placeholder="Стоимость недвижимости"/>
                    <div class="text-danger text-xs errors" id="monthPaymentError" hidden>Поле не может быть пустым</div>
                </div>
            </div>
            <!--            <div class="row">-->
            <!--                <div class="form-group">-->
            <!--                    <input type="text" class="form-control mb-md" id="monthPayment"-->
            <!--                           placeholder="Стоимость машины"/>-->
            <!--                    <div class="text-danger text-xs errors" id="monthPaymentError" hidden>Поле не может быть пустым</div>-->
            <!--                </div>-->
            <!--            </div>-->
            <div class="row">
                <div class="form-group mb-md" style="display: flex">
                    <input type="checkbox" required><p class="ml-sm">Я соглашаюсь с условиями и даю своё согласие на обработку и использование моих персональных данных.</p>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <a id="btnSubmit" href="#" class="btn btn-3d btn-warning mr-xs mb-sm pull-right">Отправить заявку</a>
                </div>
            </div>

        </form>
        <div class="alert alert-success" id="output" hidden></div>
    </div>
</div>


<script>

    function format(comma, period) {
        comma = comma || ',';
        period = period || '.';
        var split = this.toString().split('.');
        var numeric = split[0];
        var decimal = split.length > 1 ? period + split[1] : '';
        var reg = /(\d+)(\d{3})/;
        while (reg.test(numeric)) {
            numeric = numeric.replace(reg, '$1' + comma + '$2');
        }
        return numeric + decimal;
    }

    function calculate(){
        //get values of input fields
        var p_LoanAmmount = $('#loanAmountInput').val().replace(/\s/g, '');
        var p_LoanPeriod = $('#loanPeriodInput').val();
        var p_InterestRate = $('#interestRateInput').val();
        var p_Currency = $('#currency_select').val();
        var p_OpeningDate = $('#start_date').val();

        if(p_LoanAmmount === ""){
            alert("You haven't set Loan Amount");
            return;
        }
        if(p_LoanPeriod === "") {
            alert("You haven't set Loan Period");
            return;
        }
        if(p_OpeningDate === ""){
            p_OpeningDate = new SimpleDateFormat("yyyyMMdd").format(new Date());
        }

        var LoanP = 0;
        var Proc = 0;
        var K = 0;
        var Inst = 0;
        var Intrst = 0;

        if (p_LoanAmmount === "")
            p_LoanAmmount = "0";
        if (p_Currency === "")
            p_Currency = "kgs";
        if (p_LoanPeriod === "")
            p_LoanPeriod = "0";
        if (p_InterestRate === "")
            p_InterestRate = "0";

        LoanP = Number(p_LoanPeriod.split(",").join(""));
        Proc = Number(p_InterestRate.split(",").join("")) / 1200;

        K = Proc
            * (Math.pow(1 + Proc, LoanP))
            / ((Math.pow(1 + Proc, LoanP)) - 1);

        Inst = Number(p_LoanAmmount.split(",").join("")) * K;
        Intrst =Number(p_LoanAmmount.split(",").join("")) * Proc;

//		DecimalFormat decimalFormat = new DecimalFormat("#0.00");

        var installment2 = Inst;
        var procent2 = Number(p_InterestRate.split(",").join(""));
        var balance2 = Number(p_LoanAmmount.split(",").join(""));
        var interest2 = 0;
        var principal2 = 0;
        var SumInstallment = 0;
        var SumPrincipal = 0;
        var SumInterest = 0;

        var openingDate = $('#start_date').datepicker('getDate');

        var calendar = openingDate;

        // First payment date should be bigger than one month
        calendar.setDate(openingDate.getDate() + 1);

        var startDay = calendar.getDate();

        var creditTable = [];
        $("#result_table_id").empty();
        var table = document.getElementById("result_table_id");

        for ( i = 0;i < LoanP; i++) {
            calendar.setDate(1);
            calendar.setMonth(calendar.getMonth() + 1);
            var dayOfNextMonth = (new Date(calendar.getYear(), calendar.getMonth() + 1, 0)).getDate();
            calendar.setDate(dayOfNextMonth < startDay ? dayOfNextMonth : startDay);

            interest2 = balance2 * procent2 / 1200;
            principal2 = installment2 - interest2;
            balance2 = balance2 - principal2;
            SumInstallment += installment2;
            SumPrincipal += principal2;
            SumInterest += interest2;

            var row = table.insertRow(-1);

            var cell1 = row.insertCell(0);
            var cell2 = row.insertCell(1);
            var cell3 = row.insertCell(2);
            var cell4 = row.insertCell(3);
            var cell5 = row.insertCell(4);
            var cell6 = row.insertCell(5);

            // Add some text to the new cells:
            cell1.innerHTML = i+1;
            cell2.innerHTML = format.call(installment2.toFixed(2).toString().split(' ').join(''), ' ', '.');
            cell3.innerHTML = format.call(principal2.toFixed(2).toString().split(' ').join(''), ' ', '.');
            cell4.innerHTML = format.call(interest2.toFixed(2).toString().split(' ').join(''), ' ', '.');
            cell5.innerHTML = format.call(Math.abs(balance2).toFixed(2).toString().split(' ').join(''), ' ', '.');
            cell6.innerHTML = calendar.getDate() +'/'+ (parseInt(calendar.getMonth())+1) +'/'+ calendar.getFullYear();
        }

        var row = table.insertRow(-1);

        var cell1 = row.insertCell(0);
        var cell2 = row.insertCell(1);
        var cell3 = row.insertCell(2);
        var cell4 = row.insertCell(3);
        var cell5 = row.insertCell(4);
        var cell6 = row.insertCell(5);

        cell1.innerHTML = "";
        cell2.innerHTML = '<b>'+ format.call(SumInstallment.toFixed(2).toString().split(' ').join(''), ' ', '.') +'</b>';
        cell3.innerHTML = '<b>'+ format.call(SumPrincipal.toFixed(2).toString().split(' ').join(''), ' ', '.') +'</b>';
        cell4.innerHTML = '<b>'+ format.call(SumInterest.toFixed(2).toString().split(' ').join(''), ' ', '.') +'</b>';
        cell5.innerHTML = '<b>'+ (0).toFixed(2) +'</b>';
        cell6.innerHTML = calendar.getDate() +'/'+ (parseInt(calendar.getMonth())+1) +'/'+ calendar.getFullYear();
    }


    $(function() {

        //var settingsParam = <?=json_encode ( $settingsParam );?>;

        $(document).on('click','#calculator_toggle', function(){
            var this_ = $(this);
            $('#calculator').toggle(1000, function(){
                if( $('#calculator').is(':visible') ){
                    $(this_).css('border-bottom', 'none');
                }else{
                    $(this_).css("border-bottom", "2px dotted #F4A70D");
                }
            });

        });

        $('#currency_select').val('kgs');
        $('#loanAmountInput').val(format.call($('#loanAmountInput').val().split(' ').join(''), ' ', '.'));

        $(document).on('keyup', '#loanAmountInput', function () {
            $(this).val(format.call($(this).val().split(' ').join(''), ' ', '.'));
        });

        $(document).on('click', '#calculate-result', function() {
            calculate();
            $( "#result" ).show();
        });

        $(document).on('click', '.print-btn', function(){
            $(this).parents('.print-area').printArea();
        });

        $('#start_date').datepicker({
            format: "dd.mm.yyyy",
            weekStart: 1,
            language: "ru",
            daysOfWeekDisabled: "0,6",
            daysOfWeekHighlighted: "1,2,3,4,5",
            todayHighlight: true,
            toggleActive: true
        }).datepicker('setDate', new Date());


        //START OF SLIDERS SETTINGS


        // To set initial values with variable like this sinchronizes input and slider values;
        var loanAmount = {
            "max": 30000000,
        "step": 1000,
            "postfix": " "+$('#currency_select').val().toUpperCase(),
            "from": 50000
    };
        var loanTextValue;
        if(settingsParam['textValue']==null){
            loanTextValue="Кредит";
        }
        else{
            loanTextValue=settingsParam['textValue'];
        }

        var typeOfRequest;

        if (typeof (typeOfRequest== settingsParam['type'])!= null ) {
            typeOfRequest= settingsParam['type'];

            if(typeOfRequest=="CarStandard"){
                document.getElementById('initPayment').style.display = 'block';
                document.getElementById('mortgageCost').style.display = 'none';
                document.getElementById('carCost').style.display = 'block';
            }
            else if(typeOfRequest=="MortgageStandard"){
                document.getElementById('initPayment').style.display = 'block';
                document.getElementById('mortgageCost').style.display = 'block';
                document.getElementById('carCost').style.display = 'none';
            }
            else{
                document.getElementById('initPayment').style.display = 'none';
                document.getElementById('mortgageCost').style.display = 'none';
                document.getElementById('carCost').style.display = 'none';
            }

        } else {
            document.getElementById('initPayment').style.display = 'none';
            document.getElementById('mortgageCost').style.display = 'none';
            document.getElementById('carCost').style.display = 'none';
        }

        $("#loanTextValue").text(loanTextValue);
        var loanPeriod = {
            "max": 12,
        "step": 1,
        "postfix": null,
            "from": 1

    }
        //{"max": 36, "step": 1, "postfix": " <?//=Yii::t('app', 'Months')?>//", "from": <?//= isset($settingsParam['loanPeriod']['from']) ? $settingsParam['loanPeriod']['from'] : 24 ?>//};
        var interestRate = {
            "max": 30.00,
            "step": 0.01,
            "postfix": "%",
            "from": 20,
        "disabled": false
    }

        //{"max": 20.99, "step": 0.01, "postfix": "%", "from":  <?//= isset($settingsParam[isset($settingsParam['defaultCurrency']) ? $settingsParam['defaultCurrency'] : 'kgs']['rate']) ? $settingsParam[isset($settingsParam['defaultCurrency']) ? $settingsParam['defaultCurrency'] : 'kgs']['rate'] : 0?>//};

        //LOAN AMOUNT rangeSlider/input setter
        $('#loanAmountInput').jStepper({minValue: 1, maxValue: loanAmount.max});
        $("#loanAmountInput").val(format.call(loanAmount.from.toString().split(' ').join(''), ' ', '.'));
//        format.call($('#loanAmountInput').val().split(' ').join(''), ' ', '.')

        //LOAN PERIOD rangeSlider/input setter
        $('#loanPeriodInput').jStepper({minValue:0, maxValue: loanPeriod.max});
        $("#loanPeriodInput").attr("value", loanPeriod.from);

        // $("#loanTextValue").attr("value",loanAmount.text);


        var loanPeriodSlider = $("#loanPeriodSlider").data("ionRangeSlider");
        $("#loanPeriodInput").on("keyup", function(){
// 		if($(this).val() == ""){ $(this).val(0); }
            loanPeriodSlider.update({
                from: $(this).val(),
            });
        });

        $("#interestRateSlider").ionRangeSlider({
            min: interestRate.from,
            max: interestRate.max, //interestRate.max,
            type: 'single',
            disable: interestRate.disabled,
            postfix: interestRate.postfix,
            from: interestRate.from,
            from_fixed: true,
            step: interestRate.step,
            force_edges: true,
            onChange: function (obj) {
                $("#interestRateInput").val(obj.from);
            },
            onUpdate: function (obj) {
                $("#interestRateInput").val(obj.from);
            },
        });

        var interestRateSlider = $("#interestRateSlider").data("ionRangeSlider");
        $("#interestRateInput").on("keypress", function(event){
            if(event.which == 46  && $(this).val().indexOf('.') != -1) {
                event.preventDefault();
            } // prevent if already dot
        });

        $("#loanAmountSlider").ionRangeSlider({
            min: 0,
            max: loanAmount.max,
            type: 'single',
            step: loanAmount.step,
            postfix: loanAmount.postfix,
            from: loanAmount.from,
            force_edges: true,
            onFinish: function () {
                changeRateByAmountAndPeriod(settingsParam, interestRate, interestRateSlider);
            },
            onChange: function (obj) {
                $("#loanAmountInput").val(obj.from).change();
            },
            onUpdate: function (obj) {
                changeRateByAmountAndPeriod(settingsParam, interestRate, interestRateSlider);
                $("#loanAmountInput").val(obj.from).change();
            },
        });
        var loanAmountSlider = $("#loanAmountSlider").data("ionRangeSlider");
        $("#loanAmountInput").on("keyup", function(){
// 		if($(this).val() == ""){ $(this).val(0); }
            loanAmountSlider.update({
                from: $(this).val(),
            });
        });

        $("#loanPeriodSlider").ionRangeSlider({
            min: loanPeriod.from,
            max: loanPeriod.max,
            type: 'single',
            postfix: loanPeriod.postfix,
            from: loanPeriod.from,
            force_edges: true,
            onFinish: function (obj) {
                changeRateByAmountAndPeriod(settingsParam, interestRate, interestRateSlider);
            },
            onChange: function (obj) {
                $("#loanPeriodInput").val(obj.from).change();
            },
            onUpdate: function (obj) {
                changeRateByAmountAndPeriod(settingsParam, interestRate, interestRateSlider);
                $("#loanPeriodInput").val(obj.from).change();

            },
        });

        //INTEREST RATE rangeSlider/input setter
        $('#interestRateInput').jStepper({minValue:0, maxValue: (interestRate.max), allowDecimals: true, minDecimals: 3});
        $("#interestRateInput").attr("value", interestRate.from);

        $("#interestRateInput").on("keyup", function(event){
// 		if($(this).val() == ""){ $(this).val(0); }
            interestRateSlider.update({
                from: $(this).val(),
            });
        });


        $('#salary_project').on("change", function(){
            var currency = $('#currency_select').val();
            if(this.checked){
                interestRate.from = settingsParam[currency]['salaryProjectEmployeeRate'];
            }else{
                interestRate.from = settingsParam[currency]['rate'];
            }

            interestRateSlider.update({from: interestRate.from });
        });
        /*$('#loanAmountInput').on("change", function(){changeRateByAmountAndPeriod() });
         $('#loanPeriodInput').on("change", function(){changeRateByAmountAndPeriod() });*/

        $('#currency_select').on("change", function(){
            var currency = $(this).val();
            if(currency == "kgs"){
                loanAmount = {"max": 9999999, "step": 1000, "postfix": " KGS", "from": <?= isset($settingsParam['loanAmount']['from']) ? $settingsParam['loanAmount']['from'] : 50000 ?>};
                interestRate.from = <?= isset($settingsParam['kgs']['rate']) ? $settingsParam['kgs']['rate'] : 0?>;
            }else if(currency == "usd"){
                loanAmount = {"max": 1000000, "step": 50, "postfix": " $", "from": <?= isset($settingsParam['loanAmount']['from']) ? $settingsParam['loanAmount']['from'] : 50000 ?>};
                interestRate.from = <?= isset($settingsParam['usd']['rate']) ? $settingsParam['usd']['rate'] : 0?>;
            }

            // Call sliders update method with any params
            loanAmountSlider.update({
                max: loanAmount.max,
                step: loanAmount.step,
                postfix: loanAmount.postfix,
                from: loanAmount.from
            });
            //update rate sliders from param
// 		$("#interestRateInput").attr("readonly", false);
            interestRateSlider.update({from: interestRate.from });
// 		$("#interestRateInput").attr("readonly", true);
        });


        calculate();
    });

    function changeRateByAmountAndPeriod(settingsParam, interestRate, interestRateSlider){
        var currency = $('#currency_select').val();

        if(settingsParam[currency]['rateAmountByTerms'] != null){
            var loanAmountVal = parseInt($('#loanAmountInput').val());
            var loanPeriodVal = parseInt($('#loanPeriodInput').val());
            var loanAmountBoundary= 0;
            var loanPeriodBoundary = 0;

            //this loops are to find upper bounds
            $.each(settingsParam[currency]['rateAmountByTerms'], function(keyString, value) {
                var key = parseInt(keyString);
                if(( loanPeriodBoundary  < loanPeriodVal && loanPeriodBoundary < key) || ( key < loanPeriodBoundary && loanPeriodVal <= key )) loanPeriodBoundary = key;
            });
            $.each(settingsParam[currency]['rateAmountByTerms'][loanPeriodBoundary], function(keyString, value) {
                var key = parseInt(keyString);
                if(( loanAmountBoundary  < loanAmountVal && loanAmountBoundary < key) || ( key < loanAmountBoundary && loanAmountVal <= key )) loanAmountBoundary = key;
            });

            if(settingsParam[currency]['rateAmountByTerms'][loanPeriodBoundary][loanAmountBoundary] != null){
                interestRate.from = settingsParam[currency]['rateAmountByTerms'][loanPeriodBoundary][loanAmountBoundary];
//                    $("#interestRateInput").val(interestRate.from).change();
                interestRateSlider.update({from: interestRate.from });
            }

        }else{console.log("no rateAmountByTerm in this currency");}
    }
</script>

<script>

    function submit() {
        event.preventDefault();
        var settingsParam = <?=json_encode ( $settingsParam );?>;
        var nameOfCredit;
        if(settingsParam['type']==null){
            nameOfCredit="Кредит";
        }
        else{
            nameOfCredit=settingsParam['type'];
        }
        var bodyOfReq;
        var subjectN;
        var emailGroups;
        let consumerName = $('#consumerName').val();
        let emailAddress = $('#emailAddress').val();
        let phoneNumber = $('#phoneNumber').val();
        let isDemirBankSalary = $("#isDemirBankSalary option:selected").text();
        let region = $("#region option:selected").text();
        let loanSum =  parseInt($('#loanSum').val());
        let monthPayment = parseInt($('#monthPayment').val());
        let initPayment= parseInt($('#initPayment').val());
        let carCost= parseInt($('#carCost').val());
        let mortgageCost= parseInt($('#mortgageCost').val());
        if(nameOfCredit=="MortgageStandard"){
            subjectN="Заявка на ипотеку";
            emailGroups="call-center@demirbank.kg,ipoteka@demirbank.kg";
            bodyOfReq=
                "Имя: "+consumerName+" |          \nEmail: "+emailAddress+
                " |          \nНомер телефона: "+phoneNumber+" |          \nПолучаете зарплату на карту DemirBank: "+
                isDemirBankSalary+" |        \nРегион: "+region+" |           \nСумма кредита(полученный в кредитном калькуляторе): "+loanSum+
                " |          \nЕжемесячный платеж: "+monthPayment +" |        \nПервоначальный взнос: "+initPayment+" |        \nСтоимость недвижимости: "+mortgageCost;
        }
        else if(nameOfCredit=="CarStandard"){
            subjectN="Заявка на автокредит";
            emailGroups="call-center@demirbank.kg,Car_Consumer_loan@demirbank.kg";
            bodyOfReq=
                "Имя: "+consumerName+" |         \nEmail: "+emailAddress+
                " |          \nНомер телефона: "+phoneNumber+" |          \nПолучаете зарплату на карту DemirBank: "+
                isDemirBankSalary+" |        \nРегион: "+region+" |           \nСумма кредита(полученный в кредитном калькуляторе): "+loanSum+
                " |          \nЕжемесячный платеж: "+monthPayment +" |        \nПервоначальный взнос: "+initPayment+" |        \nСтоимость машины: "+carCost;
        }
        else{
            subjectN="Заявка на кредит";
            emailGroups="call-center@demirbank.kg";
            bodyOfReq=
                "Имя: "+consumerName+" |        \nEmail: "+emailAddress+
                " |          \nНомер телефона: "+phoneNumber+" |          \nПолучаете зарплату на карту DemirBank: "+
                isDemirBankSalary+" |        \nРегион: "+region+" |           \nСумма кредита(полученный в кредитном калькуляторе): "+loanSum+
                " |          \nЕжемесячный платеж: "+monthPayment;
        }
        // disabled the submit button
        $("#btnSubmit").prop("disabled", true);

        var form = new FormData();
        form.append("to", emailGroups);//"nursultan.mamytov@ctechnology.kg,tatiana.kriukova@ctechnology.kg,Altynai.Akhmatova@demirbank.kg");
        form.append("subject", subjectN);
        form.append("body", bodyOfReq);
        form.append("template", "default_template");


        var settings = {
            "url": "http://10.0.0.38:8080/notifservice/sendHtmlMailTemplate",
            "method": "POST",
            "timeout": 0,
            "processData": false,
            "mimeType": "multipart/form-data",
            "contentType": false,
            "dataType": 'multipart/form-data',
            "data": form
        };

        $.ajax(settings).done(function (response) {
            // console.log(response);
            $("#loanForm").attr("hidden", "hidden");
            $("#output").removeAttr("hidden");
            $("#output").html("Ваш запрос принят");

            $("#btnSubmit").prop("disabled", false);
        });

    }

    function validate() {
        if($('#consumerName').val().length < 1) {
            return false;
        } else if($('#emailAddress').val().length < 1) {
            return false;
        } else if($('#phoneNumber').val().length < 6 || $('#phoneNumber').val().length > 13){
            return false;
        } else if($('#isDemirBankSalary').val().length < 1) {
            return false;
        } else if($('#region').val().length < 1) {
            return false;
        } else if($('#loanSum').val().length < 1) {
            return false;
        } else if($('#monthPayment').val().length < 1) {
            return false;
        }
    }

    $('#btnSubmit').click(function (e) {
        e.preventDefault();
        console.log("clicked");

        submit();
        $("#loanForm").attr("hidden", "hidden");
        $("#output").removeAttr("hidden");
        $("#output").html("Ваш запрос принят");

        $("#btnSubmit").prop("disabled", false);
        if(validate()) {
            console.log("valid");
            $('.errors').attr("hidden", true);


        } else {
            if($('#consumerName').val().length < 1) {
                $('#consumerNameError').attr("hidden", false);
            }
            if($('#emailAddress').val().length < 1) {
                $('#emailAddressError').attr("hidden", false);
            }
            if($('#phoneNumber').val().length < 1){
                $('#phoneNumberError').attr("hidden", false);
            }
            if($('#isDemirBankSalary').val().length < 1){
                $('#isDemirBankSalaryError').attr("hidden", false);
            }
            if($('#region').val().length < 1){
                $('#regionError').attr("hidden", false);
            }
            if($('#loanSum').val().length < 1){
                $('#loanSumError').attr("hidden", false);
            }
            if($('#monthPayment').val().length < 1){
                $('#monthPaymentError').attr("hidden", false);
            }
        }
    });

</script>


</body>
</html>
